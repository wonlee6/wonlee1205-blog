---
title: 'Socket μ‚¬μ©ν•μ—¬ κ°„λ‹¨ν• μ±„ν… κµ¬ν„'
date: '2024-07-20'
tags: ['socket', 'express', 'vite-express']
description: 'Socket.io μ΄μ©ν•μ—¬ κ°„λ‹¨ν• μ±„ν… κµ¬ν„ν•΄λ³΄κΈ°'
---

`Socket.IO`λ” ν΄λΌμ΄μ–ΈνΈμ™€ μ„λ²„ κ°„ **μ‹¤μ‹κ°„ μ–‘λ°©ν–¥ ν†µμ‹ **μ„ κ°€λ¥ν•κ² ν•λ” JavaScript λΌμ΄λΈλ¬λ¦¬μ…λ‹λ‹¤.
WebSocket, ν΄λ§ λ“±μ„ λ‚΄λ¶€μ μΌλ΅ κ΄€λ¦¬ν•μ—¬ λΈλΌμ°μ € κ°„μ νΈν™μ„±κ³Ό μ•μ •μ„±μ„ μ κ³µν•©λ‹λ‹¤.

> β… ν…μ¤νΈ ν™κ²½: Bun.js (npm μ‚¬μ©λ„ λ¬΄λ°©)

## π“¦ μ„¤μΉ

```shell
bun i socket.io socket.io-client vite-express express
```

## π–¥οΈ Server μ„¤μ •

### 1. Express + HTTP μ„λ²„ κµ¬μ„±

```js showLineNumbers
import express from 'express'
import ViteExpress from 'vite-express'
import http from 'http'
import { Server } from 'socket.io'

const app = express()
const server = http.createServer(app)
```

- `Express` ν”„λ μ„μ›ν¬λ¥Ό μ‚¬μ©ν•μ—¬ κΈ°λ³Έ μ›Ή μ„λ²„λ¥Ό μ„¤μ •ν•©λ‹λ‹¤.
- `http.createServer`λ¥Ό μ‚¬μ©ν•μ—¬ Express μ• ν”λ¦¬μΌ€μ΄μ…μ„ κΈ°λ°μΌλ΅ HTTP μ„λ²„λ¥Ό μƒμ„±ν•©λ‹λ‹¤.
- `Socket.IO` μ„λ²„λ¥Ό HTTP μ„λ²„μ— μ—°κ²°ν•κΈ° μ„ν•΄ Server κ°μ²΄λ¥Ό μ‚¬μ©ν•©λ‹λ‹¤.

### 2. Socket.IO μ„λ²„ μ„¤μ •

> λ¨λ“  λ„λ©”μΈμ—μ„μ μ—°κ²°μ„ ν—μ©ν•λ” CORS μ„¤μ •μ„ μ¶”κ°€

```js showLineNumbers
const io = new Server(server, {
  cors: {
    origin: '*' // λ¨λ“  λ„λ©”μΈ ν—μ© (κ°λ°μ©)
  }
})
```

### 3. μ΄λ²¤νΈ μ²λ¦¬

```js showLineNumbers
// ν΄λΌμ΄μ–ΈνΈκ°€ μ›Ήμ†μΌ“ μ—°κ²°μ„ ν•  λ• λ°μƒν•λ” μ΄λ²¤νΈ
io.on('connection', (socket) => {
  const username = socket.handshake.query.username
  console.log(`${username} μ…μ¥`)

  // μμ‹ μ„ μ μ™Έ, μ—°κ²°λ λ¨λ“  ν΄λΌμ΄μ–ΈνΈμ—κ² λ©”μ‹μ§€λ¥Ό μ „μ†΅
  socket.broadcast.emit('message', { user: 'system', text: `${username}λ‹μ΄ μ…μ¥ν•μ€μµλ‹λ‹¤.` })

  // ν΄λΌμ΄μ–ΈνΈλ΅λ¶€ν„° λ©”μ‹μ§€λ¥Ό μμ‹ ν•λ©΄, λ¨λ“  ν΄λΌμ΄μ–ΈνΈμ—κ² μ „μ†΅
  socket.on('message', (data) => {
    console.log('Message received: ', data)
    io.emit('message', { user: username, text: data })
  })

  // ν΄λΌμ΄μ–ΈνΈκ°€ μ—°κ²°μ„ λμ„ λ• λ°μƒν•λ” μ΄λ²¤νΈ
  socket.on('disconnect', () => {
    console.log('Client disconnected')
    io.emit('message', { user: 'system', text: `${username}λ‹μ΄ λ‚κ°”μµλ‹λ‹¤.` })
  })

  // μ¤λ¥κ°€ λ°μƒν•  λ• μ²λ¦¬ν•λ” μ΄λ²¤νΈ
  socket.on('error', (error) => {
    console.error(error)
  })
})
```

- `broadcast.emit`: λ‚λ¥Ό μ μ™Έν• λ‹¤λ¥Έ ν΄λΌμ΄μ–ΈνΈμ—κ² μ „μ†΅
- `io.emit`: λ¨λ“  ν΄λΌμ΄μ–ΈνΈμ—κ² μ „μ†΅

### 4. μ„λ²„ μ‹μ‘

```js showLineNumbers
server.listen(3000, () => {
  console.log('Server is listening...')
})
```

### 5. Viteμ™€ ν†µν•©

```js
ViteExpress.bind(app, server)
```

## β… μ „μ²΄ μ½”λ“

```js showLineNumbers
import express from 'express'
import ViteExpress from 'vite-express'
import http from 'http'
import { Server } from 'socket.io'

const app = express()
const server = http.createServer(app)

const io = new Server(server, {
  cors: {
    origin: '*'
  }
})

io.on('connection', (socket) => {
  const username = socket.handshake.query.username
  console.log(`${username} μ…μ¥`)

  socket.broadcast.emit('message', { user: 'system', text: `${username}λ‹μ΄ μ…μ¥ν•μ€μµλ‹λ‹¤.` })

  socket.on('message', (data) => {
    console.log('Message received: ', data)
    io.emit('message', { user: username, text: data })
  })

  socket.on('disconnect', () => {
    console.log('Client disconnected')
    io.emit('message', { user: 'system', text: `${username}λ‹μ΄ λ‚κ°”μµλ‹λ‹¤.` })
  })

  socket.on('error', (error) => {
    console.error(error)
  })
})

server.listen(3000, () => {
  console.log('Server is listening...')
})

ViteExpress.bind(app, server)
```

## π’» Client κµ¬ν„ (React)

### κΈ°λ³Έ κµ¬μ΅°

```jsx showLineNumbers
import { useState, useCallback, useEffect } from "react"
import io, { type Socket } from "socket.io-client"

export default function WebSocketCompo() {
  const [socket, setSocket] = useState<Socket | null>(null)
  const [userName, setUserName] = useState("")
  const [chat, setChat] = useState<{ user: string; text: string }[]>([])
  const [message, setMessage] = useState("")
  const [isConnected, setIsConnected] = useState(false)

  const handleConnect = useCallback(() => {
    const ioInstance = io("http://localhost:3000", {
      autoConnect: false,
      query: { username: userName }
    })

    ioInstance.connect()
    setSocket(ioInstance)
  }, [userName])
```

### μ—°κ²° ν•΄μ  λ° λ©”μ‹μ§€ μ „μ†΅

```jsx showLineNumbers
 const handleDisconnect = useCallback(() => {
    if (socket) {
      socket.disconnect()
      console.log("μ†μΌ“ μ—°κ²° ν•΄μ ")
      setIsConnected(false)
    }
  }, [socket])

  const handleMsgSubmit = () => {
    if (message && socket) {
      socket.emit("message", message)
      setMessage("")
    }
  } const handleDisconnect = useCallback(() => {
    if (socket) {
      socket.disconnect()
      console.log("μ†μΌ“ μ—°κ²° ν•΄μ ")
      setIsConnected(false)
    }
  }, [socket])

  const handleMsgSubmit = () => {
    if (message && socket) {
      socket.emit("message", message)
      setMessage("")
    }
  }
```

### μ„λ²„ λ©”μ‹μ§€ μμ‹  μ²λ¦¬

```jsx showLineNumbers
  const handleMessage = (message: { user: string; text: string }) => {
    setChat((prevChat) => [...prevChat, message])
  }

  useEffect(() => {
    if (!socket) return

    socket.on("connect", () => setIsConnected(true))
    socket.on("disconnect", () => setIsConnected(false))
    socket.on("message", handleMessage)

    return () => {
      socket.off("connect", handleConnect)
      socket.off("disconnect", handleDisconnect)
      socket.off("message", handleMessage)
    }
  }, [socket, handleConnect, handleDisconnect])
```

### μ»΄ν¬λ„νΈ UI μμ‹

```jsx showLineNumbers
return (
  <div>
    <h1>{isConnected ? 'β… μ ‘μ†μ¤‘' : 'β μ ‘μ† μΆ…λ£'}</h1>

    <InputText
      value={userName}
      onChange={(e) => setUserName(e.target.value)}
      placeholder='λ‹‰λ„¤μ„ μ…λ ¥'
    />

    <div style={{ display: 'flex', gap: '1rem' }}>
      <Button label='Connect' onClick={handleConnect} />
      <Button label='Disconnect' onClick={handleDisconnect} />
    </div>

    <div>
      <input value={message} onChange={(e) => setMessage(e.target.value)} />
      <button onClick={handleMsgSubmit}>Send</button>
    </div>

    <ul>
      {chat.map((msg, index) => (
        <li key={index}>
          <strong>{msg.user}</strong>: {msg.text}
        </li>
      ))}
    </ul>
  </div>
)
```

### π–ΌοΈ μ‹¤ν–‰ ν™”λ©΄

![img](https://i.ibb.co/P1Qcxwt/2024-07-20-4-32-43.png)

![img](https://i.ibb.co/wgjpVQm/2024-07-20-4-35-40.png)

μ ‘μ† λ²„νΌμ„ λ„λ¥΄κ² λλ©΄ μ„μ™€ κ°™μ΄ ν™•μΈν•  μ μμµλ‹λ‹¤.

![img](https://i.ibb.co/PmJpbpv/2024-07-20-4-45-45.png)

## π§  μ •λ¦¬

> `emit`μ€ λ°©μ†΅ λ‚΄λ³΄λ‚΄κ³ , `Broadcasting` λ°©μ†΅μ„ μ²­μ·¨

| κ°λ…        | μ„¤λ…                                                  |
| ----------- | ----------------------------------------------------- |
| `emit`      | μ„λ²„ λλ” ν΄λΌμ΄μ–ΈνΈκ°€ μ΄λ²¤νΈλ¥Ό **μ „μ†΅**ν•¨            |
| `broadcast` | ν„μ¬ ν΄λΌμ΄μ–ΈνΈλ¥Ό μ μ™Έν• **λ¨λ“  ν΄λΌμ΄μ–ΈνΈ**μ—κ² μ „μ†΅ |

π§ μ—¬λ¬ λΈλΌμ°μ € νƒ­μ„ μ—΄μ–΄ ν…μ¤νΈν•΄λ³΄λ©΄, λ©”μ‹μ§€λ¥Ό μ£Όκ³ λ°›μΌλ©° μ‹¤μ‹κ°„ ν†µμ‹ μ΄ μ–΄λ–»κ² μ‘λ™ν•λ”μ§€ μ§κ΄€μ μΌλ΅ μ΄ν•΄ν•  μ μμµλ‹λ‹¤.

## π“ λ§λ¬΄λ¦¬

μ΄ μμ λ” **κΈ°μ΄μ μΈ Socket ν†µμ‹  κµ¬μ΅°**λ¥Ό μ΄ν•΄ν•λ” λ° λ„μ›€μ΄ λ©λ‹λ‹¤.
μ‹¤λ¬΄μ—μ„λ” μΈμ¦, μ—°κ²° μƒνƒ κ΄€λ¦¬, μ¤λ¥ μ²λ¦¬, λ©”μ‹μ§€ ν, λ°©(Room) κΈ°λ¥ λ“±μ„ μ¶”κ°€μ μΌλ΅ κµ¬ν„ν•΄μ•Ό ν•©λ‹λ‹¤.

π’΅ ν•μ§€λ§ μ΄ κΈ°λ³Έ κµ¬μ΅°λ§ μ μ΄ν•΄ν•΄λ„, **μ‹¤μ‹κ°„ μ‹μ¤ν…μ μ‘λ™ λ°©μ‹**μ„ λΉ λ¥΄κ² νμ•…ν•  μ μμµλ‹λ‹¤.
μ‹¤μ‹κ°„ ν‘μ—…, μ±„ν…, μ•λ¦Ό κΈ°λ¥ λ“±μ—μ„ Socketμ€ μ•„μ£Ό μ μ©ν• λ„κµ¬μ…λ‹λ‹¤!
