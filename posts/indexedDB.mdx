---
title: 'IndexedDB ì‚¬ìš©í•´ë³´ê¸°'
date: '2024-07-08'
tags: ['indexedDB', 'crypto-js']
description: 'IndexedDB í™œìš© ë°©ë²•, crypto-js ì‚¬ìš©í•˜ì—¬ ë°ì´í„° ì•”í˜¸í™”í•˜ê¸°'
---

# ğŸ—ƒï¸ IndexedDB ì‚¬ìš©í•´ë³´ê¸°

`IndexedDB`ëŠ” ë¸Œë¼ìš°ì €ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” **ë¹„ê´€ê³„í˜•(NoSQL) ë°ì´í„°ë² ì´ìŠ¤**ì…ë‹ˆë‹¤.
í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ **ëŒ€ìš©ëŸ‰ ë°ì´í„°ë¥¼ ì˜êµ¬ì ìœ¼ë¡œ ì €ì¥í•˜ê³  ì¡°íšŒ**í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„ë˜ì—ˆìœ¼ë©°,
**í‚¤-ê°’ ìŒ**ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì €ì¥í•˜ê³  **íŠ¸ëœì­ì…˜**ì„ ì§€ì›í•´ ë°ì´í„°ì˜ ì¼ê´€ì„±ì„ ë³´ì¥í•©ë‹ˆë‹¤.

## ğŸ§ª ì˜ˆì œ ì½”ë“œ

### 1. DB ì—°ê²° í•¨ìˆ˜

```ts showLineNumbers
export interface Item {
  id?: number
  name: string
}

// db.ts
export const openDatabase = (): Promise<IDBDatabase> => {
  return new Promise((resolve, reject) => {
    // indexedDB ì—°ê²°
    const request = indexedDB.open('my-database', 1)

    // ì²˜ìŒ ìƒì„±í•˜ê±°ë‚˜ ë°ì´í„°ë² ì´ìŠ¤ì˜ ìŠ¤í‚¤ë§ˆ(êµ¬ì¡°)ë¥¼ ë³€ê²½í•  ë•Œ
    request.onupgradeneeded = (event) => {
      const db = (event.target as IDBOpenDBRequest).result
      if (!db.objectStoreNames.contains('items')) {
        // autoIncrement: ìë™ìœ¼ë¡œ í‚¤ê°€ ì¦ê°€ë˜ì–´ ì…‹íŒ…ëœë‹¤. 1 > 2 > 3 ...
        db.createObjectStore('items', { keyPath: 'id', autoIncrement: true })
      }
    }
    // ì—°ê²° ì„±ê³µ
    request.onsuccess = (event) => {
      resolve((event.target as IDBOpenDBRequest).result)
    }
    // ì—°ê²° ì‹¤íŒ¨
    request.onerror = (event) => {
      reject((event.target as IDBOpenDBRequest).error)
    }
  })
}
```

ğŸ“Œ IndexedDBëŠ” **ë¹„ë™ê¸°**ë¡œ ë™ì‘í•˜ë¯€ë¡œ, ì™¸ë¶€ì—ì„œ í¸ë¦¬í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ `Promise`ë¡œ ë˜í•‘í•©ë‹ˆë‹¤.
`my-database`ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ì´ë¦„, `items`ëŠ” ì˜¤ë¸Œì íŠ¸ ìŠ¤í† ì–´(í…Œì´ë¸”ì²˜ëŸ¼ ìƒê°í•˜ë©´ ë¨)ì…ë‹ˆë‹¤.
ì¦‰, êµ¬ì¡°ëŠ” ğŸ‘‰ `my-database > items`.

![ì„ì§€](https://i.ibb.co/fv8tTfc/2024-07-07-11-40-41.png)

### 2. ë°ì´í„° ì¶”ê°€ í•¨ìˆ˜

```ts showLineNumbers
// ...
export const addItem = async (item: Item): Promise<void> => {
  const db = await openDatabase()
  return new Promise((resolve, reject) => {
    // íŠ¸ëœì­ì…˜ ìƒì„± (ì½ê¸°/ì“°ê¸° ëª¨ë“œ)
    const transaction = db.transaction('items', 'readwrite') // readonly, readwrite
    // ê°ì²´ ì €ì¥ì†Œ ì ‘ê·¼
    const store = transaction.objectStore('items')
    // ë°ì´í„° ì¶”ê°€
    const request = store.add(item)

    request.onsuccess = () => {
      resolve()
    }

    request.onerror = (event) => {
      reject((event.target as IDBRequest).error)
    }
  })
}
```

âœ”ï¸ ìœ„ í•¨ìˆ˜ë¥¼ í†µí•´ `items` ìŠ¤í† ì–´ì— ê°’ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![ã…ã„´ã…‡](https://i.ibb.co/y563PY3/2024-07-07-11-32-25.png)

### 3. ì „ì²´ ë°ì´í„° ì¡°íšŒ í•¨ìˆ˜

```ts showLineNumbers {6}
export const getAllItems = async (): Promise<Item[]> => {
  const db = await openDatabase()
  return new Promise((resolve, reject) => {
    const transaction = db.transaction('items', 'readonly')
    const store = transaction.objectStore('items')
    const request = store.getAll()

    request.onsuccess = (event) => {
      resolve((event.target as IDBRequest).result as Item[])
    }

    request.onerror = (event) => {
      reject((event.target as IDBRequest).error)
    }
  })
}
```

ğŸ“ `store.getAll()`ì„ ì‚¬ìš©í•˜ë©´ ì €ì¥ëœ ëª¨ë“  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### âš›ï¸ React ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‚¬ìš©í•˜ê¸°

```jsx showLineNumbers
function App() {
    const [items, setItems] = useState<Item[]>([]);
    const [inputValue, setInputValue] = useState("");

    useEffect(() => {
        const fetchItems = async () => {
            const allItems = await getAllItems();
            setItems(allItems);
        };

        fetchItems();
    }, []);

    const handleAddItem = async () => {
        await addItem({name: inputValue});
        const allItems = await getAllItems();
        setItems(allItems);
        setInputValue("");
    };

    return (
        <div>
            <h1>IndexedDB with React</h1>
            <input type="text" value={inputValue} onChange={(e) => setInputValue(e.target.value)} />
            <button onClick={handleAddItem}>Add Item</button>
            <ul>
                {items.map((item) => (
                    <li key={item.id}>{item.name}</li>
                ))}
            </ul>
        </div>
    );
}
```

ğŸ” ìƒˆë¡œê³ ì¹¨ í›„ì—ë„ ë°ì´í„°ê°€ ë‚¨ì•„ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. IndexedDBëŠ” **ë¸Œë¼ìš°ì €ì— ì˜êµ¬ ì €ì¥**ë˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

## ğŸ” ë°ì´í„° ì•”í˜¸í™” (with crypto-js)

ë°ì´í„°ë¥¼ ì €ì¥í•˜ê¸° ì „ì— **ì•”í˜¸í™”**í•˜ê³ , ì¡°íšŒ ì‹œ **ë³µí˜¸í™”**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ì„¤ì¹˜**

```shell
npm install crypto-js uuid
```

**ì•”í˜¸í™”/ë³µí˜¸í™” í•¨ìˆ˜**

```ts showLineNumbers
import CryptoJS from 'crypto-js'

// uuid í†µí•´ ë§Œë“  í‚¤
const secretKey = 'f60ef0e0-cf85-414e-a094-c1bb3e4bc947'

const encryptData = (data: string): string => {
  return CryptoJS.AES.encrypt(data, secretKey).toString()
}

const decryptData = (data: string): string => {
  const bytes = CryptoJS.AES.decrypt(data, secretKey)
  return bytes.toString(CryptoJS.enc.Utf8)
}
```

**ìˆ˜ì •ëœ addItem í•¨ìˆ˜ (ì•”í˜¸í™” ì ìš©)**

```ts showLineNumbers
// ìœ„ openDatabase í•¨ìˆ˜ ë‚´ autoIncrement ì œê±°
// ...
export const addItem = async (item: Omit<Item, 'id'>): Promise<void> => {
  const db = await openDatabase()
  return new Promise((resolve, reject) => {
    const transaction = db.transaction('items', 'readwrite')
    const store = transaction.objectStore('items')
    const id = CryptoJS.lib.WordArray.random(16).toString() // ëœë¤í•œ ID ìƒì„±
    const encryptedName = encryptData(item.name)
    const request = store.add({ id, name: encryptedName })

    request.onsuccess = () => {
      resolve()
    }

    request.onerror = (event) => {
      reject((event.target as IDBRequest).error)
    }
  })
}
```

**ìˆ˜ì •ëœ getAllItems í•¨ìˆ˜ (ë³µí˜¸í™” ì ìš©)**

```ts showLineNumbers
export const getAllItems = async (): Promise<Item[]> => {
  const db = await openDatabase()
  return new Promise((resolve, reject) => {
    const transaction = db.transaction('items', 'readonly')
    const store = transaction.objectStore('items')
    const request = store.getAll()

    request.onsuccess = (event) => {
      const encryptedItems = (event.target as IDBRequest).result as Item[]
      const decryptedItems = encryptedItems.map((item) => ({
        id: item.id,
        name: decryptData(item.name)
      }))

      resolve(decryptedItems)
    }

    request.onerror = (event) => {
      reject((event.target as IDBRequest).error)
    }
  })
}
```

ğŸ”’ ì‹¤ì œ ì €ì¥ëœ ê°’ì€ ì•”í˜¸í™”ë˜ì–´ ìˆê³ , ì¡°íšŒ ì‹œì—ë§Œ ë³µí˜¸í™”ë˜ì–´ ë³´ì—¬ì§‘ë‹ˆë‹¤.

![image](https://i.ibb.co/YRv3g3P/2024-07-08-12-05-38.png)

ğŸ“Œ ë‹¨ì¼ Rowë§Œ ì €ì¥í•˜ê³  ì‹¶ë‹¤ë©´?

```ts showLineNumbers
const hasData = store.get(key)
if (hasData) {
  const request = store.put({ id, name: encryptedName })
} else {
  const request = store.add({ id, name: encryptedName })
}
```

ğŸ‘† ì¡°ê±´ì„ ë¶„ê¸°í•˜ì—¬ ê°™ì€ keyì— ê°’ì„ ë®ì–´ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

--- ì¶”ê°€

## ğŸ—‘ï¸ IndexedDBì—ì„œ ë°ì´í„° ì‚­ì œí•˜ê¸°

`key`ë¥¼ ì´ìš©í•˜ì—¬ keyê°€ ìˆìœ¼ë©´ ì‚­ì œëœë‹¤.

```ts showLineNumbers
export const deleteItem = async (key: string): Promise<void> => {
  const db = await openDatabase()
  return new Promise((resolve, reject) => {
    // íŠ¸ëœì­ì…˜ ìƒì„± (ì½ê¸°/ì“°ê¸° ëª¨ë“œ)
    const transaction = db.transaction('items', 'readwrite') // readonly, readwrite
    // ê°ì²´ ì €ì¥ì†Œ ì ‘ê·¼
    const store = transaction.objectStore('items')
    // ë°ì´í„° ì¶”ê°€
    const request = store.delete(key)

    request.onsuccess = () => {
      resolve()
    }

    request.onerror = (event) => {
      reject((event.target as IDBRequest).error)
    }
  })
}
```

ğŸ—‘ï¸ í•´ë‹¹ keyì˜ ë°ì´í„°ê°€ ì¡´ì¬í•˜ë©´ ì‚­ì œë©ë‹ˆë‹¤.

## ğŸ§¾ ë§ˆë¬´ë¦¬

- `IndexedDB`ëŠ” í´ë¼ì´ì–¸íŠ¸ì—ì„œ ëŒ€ìš©ëŸ‰ ë°ì´í„°ë¥¼ ì˜êµ¬ ì €ì¥í•  ìˆ˜ ìˆëŠ” ê°•ë ¥í•œ ë¸Œë¼ìš°ì € ë‚´ì¥ ì €ì¥ì†Œì…ë‹ˆë‹¤.
- `crypto-js`ì™€ ê°™ì€ ë„êµ¬ë¥¼ í•¨ê»˜ ì‚¬ìš©í•˜ë©´ ë³´ì•ˆ ì²˜ë¦¬ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.
- Reactì™€ í•¨ê»˜ ì‚¬ìš©í•  ê²½ìš° ìƒíƒœì™€ì˜ ì—°ê²°ì„ ì ì ˆíˆ ê³ ë ¤í•˜ë©´ì„œ ì‚¬ìš©í•˜ë©´ ë”ìš± íš¨ìœ¨ì ì¸ ë°ì´í„° ì²˜ë¦¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.

ğŸ§  ë¡œì»¬ ì €ì¥ì†Œë¥¼ ë‹¤ë¤„ì•¼ í•œë‹¤ë©´, `localStorage`ë³´ë‹¤ ë” ìœ ì—°í•˜ê³  ê°•ë ¥í•œ `IndexedDB`ë¥¼ ê³ ë ¤í•´ë³´ì„¸ìš”!
